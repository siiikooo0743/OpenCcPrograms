--[[
	ReactorEntryControl
	
	Copyright (C) 2016 siiikooo0743
	
	This is used to control who can enter a reactor area. only with hazmat suite alowed.
  You can switch your armor using the Pim above the turtle.
	
  Version 0.1.1
  
	Author: siiikooo0743
	Website: https://github.com/siiikooo0743/OpenCcPrograms
]]
pim = peripheral.wrap("top")
scanner = peripheral.wrap("bottom")

function calcRealSlot(armorSlot)
  return (1 + ((armorSlot -1) * 4))
end

function isHazmat(slot)
  item = turtle.getItemDetail(calcRealSlot(slot))
  if item == nil then
    return false
  end
  
  return (item["name"] == "IC2:itemArmorHazmatHelmet")
end

function findSlot()
  for i = 1, 4, 1 do
    file = fs.open(".slots/" .. i, "r")
    p = file.readLine()
    file.close()
    if p == "" then
      return i
    end
  end

  for i = 1, 4, 1 do
    if isHazmat(i) then
      return i
    end
  end
  return -1 
end

function getSlotOfPlayer(player)
  for i = 1, 4, 1 do
    file = fs.open(".slots/" .. i, "r")
    p = file.readLine()
    file.close()
    if p == player then
      return i
    end
  end
  return -1
end

while true do
  players = scanner.getPlayers()
  open = false
  notOpen = false
  
  for key,player in pairs(players) do
    slot = getSlotOfPlayer(player['uuid'])

    if slot == -1 then
      slot = findSlot()
      if slot == -1 then
        notOpen = true
      else
        file = fs.open(".slots/" .. slot, "w")
        p = file.writeLine(player['uuid'])
        file.close()
      end
    end
    
    if (slot > 0) and not isHazmat(slot) then
      open = true
    else
      notOpen = true
    end
  end
  
  if open and (not notOpen) then
    redstone.setOutput("right", true)
  else
    redstone.setOutput("right", false)
  end
  
  
  
end

